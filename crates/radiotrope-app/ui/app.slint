import "fonts/Inter/static/Inter_18pt-Regular.ttf";
import "fonts/Inter/static/Inter_18pt-SemiBold.ttf";
import { MenuBar } from "menu-bar.slint";
import { Playback } from "playback.slint";
import { Favorites } from "favorites.slint";
import { Controls } from "controls.slint";
import { Theme } from "theme.slint";
import { NetworkStreamDialog } from "dialogs/network-stream.slint";
import { StatisticsDialog } from "dialogs/statistics.slint";
import { StationBrowserDialog, BrowseStation } from "dialogs/station-browser.slint";
import { CountryPickerDialog, CountryEntry } from "dialogs/country-picker.slint";
export { BrowseStation, CountryEntry }

export component App inherits Window {
    title: "Radiotrope";
    default-font-family: "Inter 18pt";
    background: Theme.surface;
    min-width: 640px;
    min-height: 480px;
    preferred-width: 800px;
    preferred-height: 600px;

    callback play-url(string);
    callback stop-clicked();
    callback volume-changed(float);
    callback mute-clicked();
    callback search-stations(string);
    callback browse-country(string);
    callback load-more-stations();
    callback play-station(BrowseStation);
    callback load-top-stations();
    callback load-countries();

    in-out property <string> station-name;
    in-out property <string> codec-info;
    in-out property <string> status-text;
    in-out property <float> vu-left;
    in-out property <float> vu-right;
    in-out property <[float]> spectrum;
    in-out property <bool> is-loading;
    in-out property <bool> is-error;
    in-out property <string> viz-mode <=> playback.viz-mode;
    in-out property <bool> is-playing;
    in-out property <string> now-playing-title;
    in-out property <float> volume: 1.0;
    in-out property <bool> is-muted;
    in-out property <string> station-url;
    in-out property <image> current-logo;
    out property <bool> volume-dragging: controls.volume-dragging;

    // Station browser proxy properties (for Rust access)
    in-out property <[BrowseStation]> search-results <=> browser-dialog.search-results;
    in-out property <bool> search-loading <=> browser-dialog.search-loading;
    in-out property <bool> search-loading-more <=> browser-dialog.search-loading-more;
    in-out property <string> search-error <=> browser-dialog.search-error;
    in-out property <bool> has-more <=> browser-dialog.has-more;

    // Country picker proxy properties (for Rust access)
    in-out property <[CountryEntry]> countries <=> picker-dialog.countries;
    in-out property <bool> country-loading <=> picker-dialog.loading;
    in-out property <string> country-error <=> picker-dialog.error;

    in-out property <string> stat-health;
    in-out property <string> stat-uptime;
    in-out property <string> stat-codec;
    in-out property <string> stat-bitrate;
    in-out property <string> stat-sample-rate;
    in-out property <string> stat-channels;
    in-out property <string> stat-received;
    in-out property <string> stat-segments;
    in-out property <string> stat-throughput;
    in-out property <string> stat-buffer-level;
    in-out property <string> stat-buffer-capacity;
    in-out property <string> stat-frames-played;
    in-out property <string> stat-decode-errors;
    in-out property <string> stat-underruns;

    VerticalLayout {
        MenuBar {
            open-network-stream => {
                stream-dialog.show-dialog = true;
            }
            open-station-search => {
                browser-dialog.search-mode = "search";
                browser-dialog.show-dialog = true;
                // Only load top stations on first open (no existing results)
                if browser-dialog.search-results.length == 0 {
                    browser-dialog.search-loading = true;
                    root.load-top-stations();
                }
            }
            open-country-picker => {
                picker-dialog.loading = true;
                picker-dialog.show-dialog = true;
                root.load-countries();
            }
            open-statistics => {
                stats-dialog.show-dialog = true;
            }
        }
        playback := Playback {
            station-name: root.station-name;
            codec-info: root.codec-info;
            status-text: root.status-text;
            vu-left: root.vu-left;
            vu-right: root.vu-right;
            spectrum: root.spectrum;
            is-loading: root.is-loading;
            is-error: root.is-error;
            station-logo: root.current-logo;
        }
        Favorites { vertical-stretch: 1; }
        controls := Controls {
            is-playing: root.is-playing;
            now-playing-title: root.now-playing-title;
            volume <=> root.volume;
            is-muted <=> root.is-muted;
            play-clicked => { root.play-url(root.station-url); }
            stop-clicked => { root.stop-clicked(); }
            volume-changed(vol) => { root.volume-changed(vol); }
            mute-clicked => { root.mute-clicked(); }
        }
    }

    stream-dialog := NetworkStreamDialog {
        accepted(url) => {
            root.play-url(url);
        }
    }

    stats-dialog := StatisticsDialog {
        stat-health: root.stat-health;
        stat-uptime: root.stat-uptime;
        stat-codec: root.stat-codec;
        stat-bitrate: root.stat-bitrate;
        stat-sample-rate: root.stat-sample-rate;
        stat-channels: root.stat-channels;
        stat-received: root.stat-received;
        stat-segments: root.stat-segments;
        stat-throughput: root.stat-throughput;
        stat-buffer-level: root.stat-buffer-level;
        stat-buffer-capacity: root.stat-buffer-capacity;
        stat-frames-played: root.stat-frames-played;
        stat-decode-errors: root.stat-decode-errors;
        stat-underruns: root.stat-underruns;
    }

    browser-dialog := StationBrowserDialog {
        search-stations(query) => { root.search-stations(query); }
        search-by-country(country) => { root.browse-country(country); }
        load-more() => { root.load-more-stations(); }
        station-selected(station) => { root.play-station(station); }
    }

    picker-dialog := CountryPickerDialog {
        country-selected(country) => {
            browser-dialog.search-mode = "country";
            browser-dialog.country-name = country;
            browser-dialog.search-results = [];
            browser-dialog.search-error = "";
            browser-dialog.has-more = false;
            browser-dialog.search-loading = true;
            browser-dialog.show-dialog = true;
            root.browse-country(country);
        }
        load-countries() => { root.load-countries(); }
    }
}
