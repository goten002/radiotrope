import { Theme } from "theme.slint";

component VolumeSlider inherits Rectangle {
    in-out property <float> value: 50;  // 0–100
    out property <bool> touch-pressed: touch.pressed;
    callback changed(float);

    width: 120px;
    height: 20px;

    // Track background
    Rectangle {
        x: 0;
        y: (root.height - 8px) / 2;
        width: root.width;
        height: 8px;
        border-radius: 4px;
        background: Theme.surface;
    }

    // Filled portion
    Rectangle {
        x: 0;
        y: (root.height - 8px) / 2;
        width: Math.max(0px, Math.min(root.width, root.width * Math.clamp(root.value, 0, 100) / 100));
        height: 8px;
        border-radius: 4px;
        background: Theme.accent;
    }

    // Thumb
    Rectangle {
        x: Math.max(0px, Math.min(root.width - 16px, (root.width - 16px) * Math.clamp(root.value, 0, 100) / 100));
        y: (root.height - 16px) / 2;
        width: 16px;
        height: 16px;
        border-radius: 8px;
        background: Theme.surface;
        border-width: 2px;
        border-color: Theme.accent;
    }

    touch := TouchArea {
        mouse-cursor: pointer;

        moved => {
            if (self.pressed) {
                root.value = Math.clamp(self.mouse-x / root.width * 100, 0, 100);
                root.changed(root.value);
            }
        }

        clicked => {
            root.value = Math.clamp(self.mouse-x / root.width * 100, 0, 100);
            root.changed(root.value);
        }

        scroll-event(e) => {
            root.value = Math.clamp(root.value + (e.delta-y / 1px / 24), 0, 100);
            root.changed(root.value);
            return accept;
        }
    }
}

export component Controls inherits Rectangle {
    in property <bool> is-playing;
    in property <string> now-playing-title;
    in-out property <float> volume: 1.0;   // 0.0–1.0
    in-out property <bool> is-muted;

    callback play-clicked();
    callback stop-clicked();
    callback volume-changed(float);        // 0.0–1.0
    callback mute-clicked();

    out property <bool> volume-dragging: vol-slider.touch-pressed;

    height: 58px;
    background: Theme.panel;

    // 1px top separator
    Rectangle {
        y: 0;
        height: 1px;
        background: Theme.surface;
    }

    HorizontalLayout {
        padding-left: 14px;
        padding-right: 14px;
        padding-top: 6px;
        padding-bottom: 6px;
        spacing: 16px;

        // ── Play / Stop button (left) ──
        VerticalLayout {
            alignment: center;
            Rectangle {
                width: 42px;
                height: 42px;
                border-radius: 6px;
                background: play-touch.has-hover ? Theme.accent-hover : Theme.accent;

                Image {
                    width: 18px;
                    height: 18px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    source: root.is-playing ? @image-url("icons/stop.svg") : @image-url("icons/play.svg");
                    colorize: Theme.button-text;
                }

                play-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        if (root.is-playing) {
                            root.stop-clicked();
                        } else {
                            root.play-clicked();
                        }
                    }
                }
            }
        }

        // ── Now Playing (fills available space, left-aligned, collapses first) ──
        Rectangle {
            horizontal-stretch: 1;
            clip: true;

            if now-playing-title != "" : VerticalLayout {
                spacing: 6px;
                alignment: center;
                height: parent.height;
                HorizontalLayout {
                    spacing: 4px;
                    alignment: start;
                    Image {
                        width: 12px;
                        height: 12px;
                        source: @image-url("icons/music-note.svg");
                        colorize: Theme.text-secondary;
                    }
                    Text {
                        text: "Now Playing";
                        font-size: 10px;
                        color: Theme.text-secondary;
                    }
                }
                TextInput {
                    text: root.now-playing-title;
                    font-size: 12px;
                    color: Theme.text-secondary;
                    horizontal-alignment: left;
                    read-only: true;
                    single-line: true;
                }
            }
        }

        // ── Volume controls (right, fixed size) ──
        HorizontalLayout {
            horizontal-stretch: 0;
            spacing: 8px;

            // Mute button
            VerticalLayout {
                alignment: center;
                Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 4px;
                    background: mute-touch.has-hover ? Theme.surface : transparent;

                    Image {
                        width: 20px;
                        height: 20px;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2;
                        source: root.is-muted ? @image-url("icons/volume-xmark.svg")
                            : root.volume < 0.01 ? @image-url("icons/volume-off.svg")
                            : root.volume < 0.33 ? @image-url("icons/volume-low.svg")
                            : root.volume < 0.66 ? @image-url("icons/volume-medium.svg")
                            : @image-url("icons/volume-high.svg");
                        colorize: Theme.text-secondary;
                    }

                    mute-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            root.mute-clicked();
                        }
                    }
                }
            }

            // Volume slider
            VerticalLayout {
                alignment: center;
                vol-slider := VolumeSlider {
                    value: root.volume * 100;
                    changed(val) => {
                        root.volume = val / 100;
                        root.volume-changed(val / 100);
                    }
                }
            }

            // Percentage text
            VerticalLayout {
                alignment: center;
                Text {
                    width: 32px;
                    text: root.is-muted ? "0%"
                        : vol-slider.touch-pressed ? Math.round(vol-slider.value) + "%"
                        : Math.round(root.volume * 100) + "%";
                    font-size: 11px;
                    color: Theme.text-secondary;
                    horizontal-alignment: right;
                }
            }
        }
    }
}
